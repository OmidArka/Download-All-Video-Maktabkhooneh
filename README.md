# دانلود دسته‌ای دوره‌های مکتبخونه (راهنمای کامل)

این راهنما **گام‌به‌گام** و حرفه‌ای برای دانلود یک‌جای ویدیوهای دوره‌هایی است که شما مجوز دانلود تک‌تک آنها را دارید (مثلاً دوره را خریداری یا اجاره کرده‌اید). می‌توانید این فایل را مستقیماً در مخزن GitHub خود قرار دهید (`README.md`).

> نکته اخلاقی و قانونی: این راهنما فرض می‌کند شما حق دسترسی و دانلود محتوای دوره را دارید. از دانلود یا انتشار غیرمجاز محتوای محافظت‌شده خودداری کنید.

---

## فهرست مطالب

1. پیش‌نیازها
2. دریافت و آماده‌سازی اسکریپت
3. استخراج `sessionid` (کوکی)
4. دو روش برای قرار دادن کوکی (متغیر محیطی یا فایل)
5. گرفتن URL به‌صورت `URL-encoded` (نکتهٔ مهم)
6. اجرای اسکریپت — دستورات نمونه
7. تست نمونه (sample-bytes)
8. وقتی ویدیوها استریم HLS (`.m3u8`) هستند — استفاده از `ffmpeg`
9. مشکلات متداول و راه‌حل‌ها
10. مثال‌های قابل کپی/پیست (PowerShell)
11. نکات تکمیلی و عیب‌یابی

---

# 1. پیش‌نیازها

* **Node.js v18 یا بالاتر** (در ویندوز PowerShell یا در لینوکس/macOS). بررسی:

```powershell
node -v
# باید چیزی شبیه v18.x.x یا بالاتر ببینی. (مثلاً v22.18.0)
```

* فایل/اسکریپت `download.mjs` که مربوط به پروژه دانلود مکتبخونه است (یا همان ریپازیتوری‌ای که دانلود کردی).
* (اختیاری اما مفید) **ffmpeg** برای تبدیل یا دانلود استریم‌های HLS.

---

# 2. دریافت و آماده‌سازی اسکریپت

1. اگر ریپازیتوری را به‌صورت ZIP دانلود کردی، آن را اکسترکت کن و وارد پوشه‌ای شو که `download.mjs` در آن قرار دارد. مثال:

```powershell
cd "C:\Users\Arka\Downloads\maktabkhooneh-downloader-main"
dir
# باید فایل download.mjs اینجا دیده شود
```

2. اگر ریپازیتوری دارای `package.json` است، بهتر است وابستگی‌ها را نصب کنی:

```powershell
npm install
```

3. برای دیدن گزینه‌های اسکریپت:

```powershell
node .\download.mjs --help
```

---

# 3. استخراج `sessionid` (کوکی)

اسکریپت برای دسترسی به ویدیوها باید هویت شما را (کوکی لاگین) داشته باشد. مراحل در Chrome/Edge/Firefox:

1. وارد حساب خود در `maktabkhooneh.org` شو و مطمئن شو لاگین هستی.
2. به صفحهٔ دوره موردنظر برو (صفحه‌ای که لیست جلسات یا خود یک جلسه را نشان می‌دهد).
3. **F12** بزن → به تب **Network** برو → صفحه را Refresh کن (F5).
4. روی اولین درخواست در لیست سمت چپ کلیک کن (معمولاً URL صفحه یا `/`).
5. در پنجرهٔ سمت راست، بخش **Headers** را باز کن و در میان Headerها دنبال خط `Cookie:` بگرد.
6. در میان مقدار Cookie دنبال `sessionid=...;` باش و فقط مقدار کامل `sessionid=...;` را کپی کن (تا شامل `;` انتهایی هم باشد).

> روش جایگزین (سریع‌تر): در DevTools تب **Application → Cookies** را باز کن، دامنهٔ `maktabkhooneh.org` را انتخاب کن و مقدار `sessionid` را از آنجا کپی کن.

---

# 4. قرار دادن کوکی (دو روش)

## روش A — متغیر محیطی (موقت در همان پنجرهٔ PowerShell)

```powershell
$env:MK_COOKIE = 'sessionid=YOUR_SESSIONID_HERE;'
```

* این فقط برای همان نشست PowerShell فعال است. اگر پنجره را ببندی، حذف می‌شود.
* اگر می‌خوای دائمی کنی از `setx` استفاده کن (توجه: پس از `setx` باید یک پنجرهٔ جدید باز کنی تا مقدار جدید در دسترس باشد):

```powershell
setx MK_COOKIE "sessionid=YOUR_SESSIONID_HERE;"
# سپس پنجرهٔ جدید PowerShell را باز کن و ادامه بده
```

## روش B — استفاده از فایل کوکی (پیشنهادی وقتی کوکی طولانی یا پیچیده است)

1. یک فایل متنی بساز (مثلاً `cookie.txt`) و متن زیر را داخل آن بنویس:

```
sessionid=YOUR_SESSIONID_HERE;
```

2. سپس در PowerShell مسیر فایل را به محیط معرفی کن:

```powershell
$env:MK_COOKIE_FILE = (Resolve-Path .\cookie.txt).Path
# یا مقدار کامل مسیر را به صورت رشته قرار بده
# $env:MK_COOKIE_FILE = 'C:\Users\Arka\Downloads\maktabkhooneh-downloader-main\cookie.txt'
```

> دقت کن: بعضی اسکریپت‌ها از `MK_COOKIE` استفاده می‌کنند و بعضی دیگر `MK_COOKIE_FILE` را پشتیبانی می‌کنند — مستندات اسکریپتی که استفاده می‌کنی را چک کن. اگر هر دو پشتیبانی شدند، فایل روش ایمن‌تری است.

---

# 5. گرفتن URL به‌صورت `URL-encoded` (نکتهٔ مهم)

خطاهایی مثل:

```
Cannot convert argument to a ByteString because the character at index 33 has a value of 1570 which is greater than 255.
```

معمولاً زمانی رخ می‌دهد که آدرس (URL) شامل حروف غیر ASCII (مثلاً فارسی) باشد و اسکریپت نتواند آنها را مستقیم پردازش کند. باید آدرس را به شکل Percent-encoded بدهی.

**روش‌های ساده برای گرفتن URL encoded:**

### الف) (پیشنهادی) از مرورگر — کنسول

1. در صفحهٔ دوره، **F12** → تب **Console**.
2. تایپ کن و Enter بزن:

```javascript
encodeURI(location.href)
```

3. خروجی را کپی کن — این همان URL کدگذاری‌شده است. آن را داخل کوتیشن به اسکریپت پاس بده.

### ب) در PowerShell (اگر می‌خواهی از رشتهٔ فارسی خودت استفاده کنی):

```powershell
$raw = 'https://maktabkhooneh.org/course/آموزش-لینوکس-.../'
[System.Uri]::EscapeUriString($raw)
```

> نکتهٔ عملی: بهترین و مطمئن‌ترین راه این است که URL را از **نوار آدرس مرورگر** کپی کن یا از `encodeURI(location.href)` استفاده کنی — مرورگر معمولاً نسخهٔ encoded را تولید می‌کند.

---

# 6. اجرای اسکریپت — دستورات نمونه

ابتدا وارد پوشهٔ اسکریپت شو:

```powershell
cd "C:\Users\Arka\Downloads\maktabkhooneh-downloader-main"
```

اگر وابستگی هست نصب کن:

```powershell
npm install
```

حالا (با فرض اینکه مقدار کوکی در `MK_COOKIE` یا `MK_COOKIE_FILE` قرار دارد و URL را به‌صورت encoded داری):

```powershell
node .\download.mjs "PASTE_ENCODED_URL_HERE"
```

**اجرای تستی (نمونه‌برداری 64KB و نمایش لاگ):**

```powershell
node .\download.mjs "PASTE_ENCODED_URL_HERE" --sample-bytes 65536 --verbose
```

> برای دیدن تمام آپشن‌ها حتماً `--help` را امتحان کن:

```powershell
node .\download.mjs --help
```

---

# 7. تست عملکرد (نمونه‌برداری)

اگر می‌خواهی اول تأیید کنی که لینک‌ها و احراز هویت درست هستند، گزینهٔ `--sample-bytes` را استفاده کن تا فقط بخش ابتدایی هر ویدیو دانلود شود. مثال:

```powershell
node .\download.mjs "PASTE_ENCODED_URL_HERE" --sample-bytes 131072 --verbose
```

اگر نمونه‌ها درست دانلود شدند، ادامهٔ کامل دانلود احتمالاً بدون مشکل انجام خواهد شد.

---

# 8. وقتی ویدیوها به صورت HLS (`.m3u8`) هستند — استفاده از `ffmpeg`

بعضی ویدیوها مستقیم `mp4` نیستند و با HLS پخش می‌شوند (فایل لیست `.m3u8`). در این حالت معمولاً اسکریپت لینک `.m3u8` را دریافت می‌کند و دو حالت پیش می‌آید:

* اسکریپت خودش `ffmpeg` را فراخوانی و ترکیب می‌کند — نیازی به کار اضافه نیست.
* اگر اسکریپت فقط لینک `.m3u8` را ذخیره کرد، می‌توانی با `ffmpeg` دانلود و ترکیب کنی:

```powershell
ffmpeg -protocol_whitelist file,http,https,tcp,tls,crypto -i "https://.../playlist.m3u8" -c copy "session-01.mp4"
```

> اگر سایت نیاز به هدر Cookie دارد، می‌توانی به ffmpeg هدر اضافه کنی (مثال در لینوکس):
> `ffmpeg -headers "Cookie: sessionid=...;" -i "...m3u8" -c copy out.mp4`

در ویندوز PowerShell ممکن است لازم باشد از escape خاص استفاده کنی یا از یک فایل `.txt` برای هدرها بهره ببری.

---

# 9. مشکلات متداول و راه‌حل‌ها

### خطا: `Cannot find module '...download.mjs'` یا `MODULE_NOT_FOUND`

* اطمینان حاصل کن که در پوشه‌ای هستی که `download.mjs` در آن قرار دارد (`cd` صحیح).
* اگر ماژول‌های خارجی لازمند، `npm install` را اجرا کن.

### خطا: `Cannot convert argument to a ByteString ... value greater than 255` (مثلاً عدد 1570)

* آدرس شامل کاراکترهای غیر-ASCII است؛ باید URL را به‌صورت encoded (مثلاً با `encodeURI(location.href)` در کنسول) به اسکریپت بدهی.

### خطا: `Failed to verify authentication` یا عدم دانلود ویدیوها

* کوکی (`sessionid`) اشتباه، منقضی یا مربوط به نشست دیگری است.
* راه‌حل: در مرورگر لاگ اوت و دوباره لاگین کن، سپس `sessionid` جدید را بگیر و دوباره تنظیم کن.
* دقت کن که مقدار کوکی را **با `;` انتهایی** قرار دهی: `sessionid=...;`

### خطا: 403 / دسترسی ممنوع

* احتمال دارد اسکریپت نیاز به هدرهای اضافی (مثل `Referer` یا `User-Agent`) داشته باشد. بعضی اسکریپت‌ها گزینه‌ای برای ارسال هدر دارند (به مستندات اسکریپت نگاه کن).

### خطاهای مربوط به `ffmpeg`

* مطمئن شو `ffmpeg` نصب و در PATH قرار دارد.
* اگر دانلود M3U8 شکست خورد، ممکن است سایت از Adaptive Bitrate یا توکن کوتاه‌مدت استفاده کند؛ در این صورت باید لینک‌ها را سریع‌تر استفاده کنی یا از روش‌های دیگری (مثلاً همان اسکریپت اصلی) بهره ببری.

---

# 10. مثال‌های قابل کپی/پیست (PowerShell)

1. وارد پوشه و نصب وابستگی (در صورت وجود):

```powershell
cd "C:\Users\Arka\Downloads\maktabkhooneh-downloader-main"
npm install
```

2. تنظیم کوکی (موقت برای همان پنجره):

```powershell
$env:MK_COOKIE = 'sessionid=PASTE_YOUR_SESSIONID_HERE;'
```

3. گرفتن URL کدگذاری‌شده — سریع در مرورگر: DevTools → Console → `encodeURI(location.href)` و آن را کپی کن.

4. اجرای دانلود:

```powershell
node .\download.mjs "PASTE_ENCODED_URL_HERE"
```

5. اجرای تست نمونه و نمایش لاگ:

```powershell
node .\download.mjs "PASTE_ENCODED_URL_HERE" --sample-bytes 65536 --verbose
```

6. ساخت فایل کوکی و استفاده از `MK_COOKIE_FILE`:

```powershell
Set-Content -Path .\cookie.txt -Value 'sessionid=PASTE_YOUR_SESSIONID_HERE;'
$env:MK_COOKIE_FILE = (Resolve-Path .\cookie.txt).Path
node .\download.mjs "PASTE_ENCODED_URL_HERE"
```

---

# 11. نکات تکمیلی و عیب‌یابی سریع

* اگر اسکریپت لاگ خطا می‌دهد، اولین قدم: `--verbose` یا `--debug` را فعال کن تا لاگ کامل ببینی.
* همیشه مطمئن شو که کوکی در همان نشست شِل تنظیم شده — اگر کوکی را در پنجرهٔ دیگری تنظیم کردی (مثلاً `setx`) ممکن است تا باز کردن پنجرهٔ جدید موثر نشود.
* اگر نیاز به دانلود همزمان تعداد زیادی ویدیو داری و اسکریپت آن را پشتیبانی نمی‌کند، می‌توانی خروجی لینک‌ها را با `maktabkhone_links.txt` ذخیره کرده و از یک دانلودمنیجر (مثل IDM یا wget/aria2) استفاده کنی.

---

## پایانی

اگر می‌خواهی من یک نسخهٔ `download.mjs` آماده یا یک اسکریپت PowerShell کمکی بنویسم که خودش:

* `sessionid` را از ورودی بگیرد،
* URL را خودکار encode کند،
* و اجرای `node` را با آرگومان‌های مناسب انجام دهد —

بگویی تا برات یک فایل `run-download.ps1` تولید کنم که کافیست مقدار `sessionid` و `url` را وارد کنی و همهٔ کارها خودکار اجرا شوند.

موفق باشی! اگر خواستی من تغییراتی در این README بدهم (مثلاً اضافه کردن بخش License یا نمونهٔ خروجی لاگ)، بگو تا اعمال کنم.
